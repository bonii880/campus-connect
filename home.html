<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Home ‚Äî CampusConnect</title>

<!-- Styles: romantic theme + heart animation -->
<style>
  :root{
    --pink1:#ff7ab6; --pink2:#ff3b88; --card:#1a0b13;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; font-family:Inter, Poppins, system-ui;
    background: linear-gradient(180deg,#120013 0%, #2a0620 100%);
    color:#fff; -webkit-font-smoothing:antialiased;
  }

  /* Animated hearts background (subtle) */
  .hearts {
    position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden;
    background: radial-gradient(circle at 10% 10%, rgba(255,77,166,0.05), transparent 10%),
                radial-gradient(circle at 90% 90%, rgba(255,20,147,0.04), transparent 10%);
  }
  .heart { position: absolute; width: 40px; height: 40px; transform: translate(-50%,-50%); opacity:0.12; animation: floatUp linear infinite; }
  @keyframes floatUp {
    from { transform: translate(-50%, 120vh) scale(0.6); opacity: 0.12; }
    to   { transform: translate(-50%, -10vh) scale(1.1); opacity: 0.02; }
  }

  /* Layout */
  .wrap{position:relative; z-index:1; max-width:960px; margin:28px auto; padding:18px;}
  header{display:flex;align-items:center;gap:12px; justify-content:space-between;}
  .profile-btn{display:flex;align-items:center;gap:10px}
  .small-avatar{width:56px;height:56px;border-radius:50%;object-fit:cover;border:3px solid rgba(255,77,166,0.25); box-shadow:0 8px 20px rgba(255,20,147,0.08); cursor:pointer}
  .nickname{font-weight:700;font-size:18px;color:#ffd6ea}

  .top-actions{display:flex;gap:10px;align-items:center}
  .action-btn{background:linear-gradient(90deg,var(--pink1),var(--pink2)); border:none;color:white;padding:10px 14px;border-radius:10px; cursor:pointer; font-weight:700}

  /* Main feed: matches top-to-bottom (max 6) */
  .feed{margin-top:22px; display:flex; flex-direction:column; gap:16px}
  .card{
    display:flex; gap:14px; align-items:flex-start;
    background: rgba(255,255,255,0.03); padding:14px; border-radius:12px; border:1px solid rgba(255,20,147,0.04);
  }
  .card .photo{width:160px;height:160px;border-radius:12px;object-fit:cover;flex-shrink:0; border:3px solid rgba(255,77,166,0.08)}
  .meta{flex:1}
  .meta h3{margin:0;font-size:20px;color:#fff}
  .meta p{margin:6px 0;color:#ffd6ea}
  .meta .small{font-size:13px;color:#f8cfe0}

  .card .controls{display:flex;flex-direction:column;gap:8px;align-items:center}
  .emoji-btn{width:56px;height:56px;border-radius:12px;border:none;background:#fff;color:#000;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}
  .like{background:linear-gradient(90deg,#ff8dbd,#ff4da6); color:white}
  .pass{background:transparent;border:2px solid rgba(255,255,255,0.06); color:#ffd6ea}

  .no-match{padding:40px;text-align:center;color:#ffd6ea;font-size:18px}

  /* Modal for showing user's photos */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:40}
  .modal .panel{width:90%;max-width:720px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));padding:18px;border-radius:14px}
  .photos{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
  .photos img{width:160px;height:160px;object-fit:cover;border-radius:12px;border:3px solid rgba(255,77,166,0.08)}

  /* small footer nav */
  .bottom-nav{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);display:flex;gap:10px}
  .nav-btn{background:rgba(255,255,255,0.06);border:none;padding:10px 14px;border-radius:10px;color:#ffd6ea;cursor:pointer}

  /* nice fade-in */
  .fadeIn{animation:fadeIn .5s ease}
  @keyframes fadeIn { from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)} }
</style>
</head>
<body>

  <!-- animated hearts - generated by JS for variety -->
  <div class="hearts" id="heartsRoot"></div>

  <div class="wrap">
    <header>
      <div class="profile-btn">
        <img id="meAvatar" class="small-avatar" src="https://via.placeholder.com/300x300.png?text=You" title="Click to view your photos">
        <div>
          <div class="nickname" id="meNick">Loading...</div>
          <div class="small" id="meSub">Your matches are below</div>
        </div>
      </div>

      <div class="top-actions">
        <button class="action-btn" id="messagesBtn">Messages</button>
        <button class="action-btn" id="editBtn">Edit Profile</button>
        <button class="action-btn" id="logoutBtn">Logout</button>
      </div>
    </header>

    <main class="feed" id="feedArea" style="margin-top:18px">
      <!-- match cards injected here (max 6) -->
    </main>

    <div id="noMatch" class="no-match" style="display:none">No matches yet ‚Äî we‚Äôll find someone special soon üíï</div>

    <!-- modal: show my photos in round form + other photos -->
    <div id="myPhotosModal" class="modal">
      <div class="panel fadeIn">
        <h3 style="margin:0 0 10px">Your Photos</h3>
        <div class="photos" id="myPhotosContainer"></div>
        <div style="text-align:center;margin-top:12px">
          <button onclick="closeModal()" class="action-btn">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- bottom nav -->
  <div class="bottom-nav">
    <button class="nav-btn" onclick="window.location.href='home.html'">Home</button>
    <button class="nav-btn" onclick="window.location.href='messages.html'">Messages</button>
    <button class="nav-btn" onclick="window.location.href='profile_view.html'">Profile</button>
    <button class="nav-btn" onclick="window.location.href='matches.html'">Matches</button>
  </div>

<script type="module">
  // firebase.js must export: auth, db, storage
  import { auth, db, storage } from './firebase.js';
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
  import { collection, getDocs, doc, getDoc, query, where, setDoc, getDocsFromLocalCache } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
  import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

  // UI refs
  const meAvatar = document.getElementById('meAvatar');
  const meNick = document.getElementById('meNick');
  const feedArea = document.getElementById('feedArea');
  const noMatchEl = document.getElementById('noMatch');
  const myPhotosModal = document.getElementById('myPhotosModal');
  const myPhotosContainer = document.getElementById('myPhotosContainer');

  let currentUser = null;
  let myProfile = null;

  // create subtle heart elements in background
  (function createHearts(){
    const root = document.getElementById('heartsRoot');
    const colors = ['rgba(255,77,166,0.12)', 'rgba(255,20,147,0.10)','rgba(255,120,190,0.09)'];
    for(let i=0;i<18;i++){
      const el = document.createElement('div');
      el.classList.add('heart');
      el.style.left = (Math.random()*100) + '%';
      el.style.top  = (Math.random()*100) + '%';
      el.style.width = (30 + Math.random()*60) + 'px';
      el.style.height = el.style.width;
      el.style.backgroundImage = `radial-gradient(circle at 30% 30%, ${colors[i%colors.length]}, transparent 40%)`;
      el.style.animationDuration = (18 + Math.random()*12) + 's';
      el.style.opacity = 0.08 + Math.random()*0.12;
      root.appendChild(el);
    }
  })();

  // small helpers
  function el(tag, props={}, children=[]){
    const e = document.createElement(tag);
    Object.entries(props).forEach(([k,v])=> e[k]=v);
    children.forEach(c=> e.appendChild(c));
    return e;
  }

  // handle auth
  onAuthStateChanged(auth, async user => {
    if(!user){ window.location.href='login.html'; return; }
    currentUser = user;
    await loadMyProfile();
    await loadMatches();
  });

  async function loadMyProfile(){
    // try students then outsiders
    const u = currentUser.uid;
    const sDoc = await getDoc(doc(db,'students',u));
    const oDoc = await getDoc(doc(db,'outsiders',u));
    myProfile = sDoc.exists() ? sDoc.data() : (oDoc.exists() ? oDoc.data() : null);

    if(!myProfile){
      // send user to choose profile creation
      window.location.href = 'choose.html';
      return;
    }
    meNick.textContent = myProfile.nickname || myProfile.name;
    meAvatar.src = myProfile.profilePic || 'https://via.placeholder.com/300x300.png?text=You';
    // Fill my photos container
    myPhotosContainer.innerHTML = '';
    const photos = myProfile.photos || (myProfile.profilePic ? [myProfile.profilePic] : []);
    photos.forEach(url=>{
      const img = el('img',{src:url});
      myPhotosContainer.appendChild(img);
    });
  }

  // open modal on avatar click
  meAvatar.addEventListener('click', ()=> {
    myPhotosModal.style.display = 'flex';
  });
  window.closeModal = ()=> myPhotosModal.style.display='none';

  // log out
  document.getElementById('logoutBtn').addEventListener('click', async ()=>{
    await signOut(auth);
    window.location.href='login.html';
  });

  document.getElementById('messagesBtn').addEventListener('click', ()=> {
    window.location.href='messages.html';
  });
  document.getElementById('editBtn').addEventListener('click', ()=> {
    // redirect to appropriate edit page (student/outsider)
    if(myProfile.userType === 'student') window.location.href='student_profile.html';
    else window.location.href='outsider_profile.html';
  });

  // Matching logic: fetch pool and filter according to preferences.
  async function loadMatches(){
    feedArea.innerHTML = '';
    noMatchEl.style.display = 'none';
    // get both students and outsiders
    const studentsSnap = await getDocs(collection(db,'students'));
    const outsidersSnap = await getDocs(collection(db,'outsiders'));
    const students = studentsSnap.docs.map(d=>d.data());
    const outsiders = outsidersSnap.docs.map(d=>d.data());

    // build candidate pool based on myProfile.interestedIn or myProfile.userType rules
    let pool = [];
    if(myProfile.userType === 'student'){
      if(myProfile.interestedIn === 'Student') pool = students.filter(s=> s.uid !== currentUser.uid);
      else if(myProfile.interestedIn === 'Outsider') pool = outsiders;
      else pool = [...outsiders, ...students.filter(s=> s.uid !== currentUser.uid)];
    } else {
      // outsider: match per their matchPreference (they choose who they want)
      if(myProfile.matchPreference === 'Student') pool = students;
      else if(myProfile.matchPreference === 'Outsider') pool = outsiders.filter(o=> o.uid !== currentUser.uid);
      else pool = [...students, ...outsiders.filter(o=> o.uid !== currentUser.uid)];
    }

    // scoring: simple match score based on overlapping criteria
    const scored = pool.map(candidate => {
      let score = 0;
      // prefer matching counties
      if(myProfile.matchPreferences?.county && candidate.county && candidate.county.toLowerCase().includes(myProfile.matchPreferences.county.toLowerCase())) score += 20;
      // age range
      if(myProfile.matchPreferences?.ageRange && candidate.age){
        const r = myProfile.matchPreferences.ageRange.split('-').map(x=>parseInt(x.trim()));
        if(r.length===2 && candidate.age >= r[0] && candidate.age <= r[1]) score += 18;
      }
      // if myProfile is student and prefers mumama/mubaba
      if(Array.isArray(myProfile.lookingFor) && myProfile.lookingFor.length){
        // increase score if candidate's youAre matches (for outsiders)
        if(candidate.youAre && myProfile.lookingFor.includes(candidate.youAre)) score += 18;
        // if candidate is student and shares any lookingFor option
        if(candidate.lookingFor && Array.isArray(candidate.lookingFor)){
          const intersect = candidate.lookingFor.filter(x=> myProfile.lookingFor.includes(x));
          if(intersect.length) score += 14;
        }
      }
      // university/year match if present
      if(myProfile.matchPreferences?.university && candidate.university && candidate.university.toLowerCase().includes(myProfile.matchPreferences.university.toLowerCase())) score += 12;
      if(myProfile.matchPreferences?.year && candidate.year && candidate.year === myProfile.matchPreferences.year) score += 8;
      // occupation matching for outsiders
      if(myProfile.matchPreferences?.occupation && candidate.occupation && candidate.occupation.toLowerCase().includes(myProfile.matchPreferences.occupation.toLowerCase())) score += 10;

      // base preference for candidate having profile pic
      if(candidate.profilePic) score += 6;

      return { candidate, score };
    });

    // sort by score desc
    scored.sort((a,b)=> b.score - a.score);

    const top = scored.filter(s=> s.score>0).slice(0,6).map(s=> s.candidate);

    if(top.length === 0){
      noMatchEl.style.display = 'block';
      return;
    }

    // display top matches
    top.forEach(profile => {
      const card = el('div',{className:'card fadeIn'});
      const photo = el('img',{className:'photo', src: profile.profilePic || 'https://via.placeholder.com/400x300?text=No+Photo'});
      const meta = el('div',{className:'meta'});
      meta.appendChild(el('h3',{innerText: (profile.nickname || profile.name) + (profile.age ? `, ${profile.age}`: '')}));
      meta.appendChild(el('p',{innerText: profile.university || profile.occupation || profile.county || ''}));
      meta.appendChild(el('p',{className:'small', innerText: (profile.lookingFor && Array.isArray(profile.lookingFor) ? profile.lookingFor.join(', ') : profile.lookingFor || '')}));

      const controls = el('div',{className:'controls'});
      const passBtn = el('button',{className:'emoji-btn pass', innerText: '‚ùå'});
      const likeBtn = el('button',{className:'emoji-btn like', innerText: '‚ù§Ô∏è'});

      passBtn.addEventListener('click', ()=> handlePass(profile));
      likeBtn.addEventListener('click', ()=> handleLike(profile));

      controls.appendChild(passBtn);
      controls.appendChild(likeBtn);

      card.appendChild(photo);
      card.appendChild(meta);
      card.appendChild(controls);
      feedArea.appendChild(card);
    });
  }

  // Like handling: save like and check for mutual
  async function handleLike(profile){
    // save like doc under likes/{currentUser.uid}/{profile.uid}
    try{
      await setDoc(doc(db, 'likes', `${currentUser.uid}_${profile.uid}`), {
        from: currentUser.uid,
        to: profile.uid,
        createdAt: new Date()
      });

      // check if they liked us
      const reciprocal = await getDoc(doc(db, 'likes', `${profile.uid}_${currentUser.uid}`));
      if(reciprocal.exists()){
        // create matches doc id (sorted uids)
        const ids = [currentUser.uid, profile.uid].sort().join('_');
        await setDoc(doc(db, 'matches', ids), {
          users: [currentUser.uid, profile.uid],
          createdAt: new Date()
        });
        alert('üéâ It\'s a match! Open Messages to chat anonymously.');
      } else {
        // just notify
        alert('You liked them ‚ù§Ô∏è ‚Äî if they like you back it\'ll be a match.');
      }
    }catch(err){
      console.error(err); alert('Failed to like: '+err.message);
    }
  }

  async function handlePass(profile){
    // For now just remove the card and show a small toast
    alert('Passed');
    // optionally save pass record
    try {
      await setDoc(doc(db, 'passes', `${currentUser.uid}_${profile.uid}`), {
        from: currentUser.uid, to: profile.uid, createdAt: new Date()
      });
    } catch(e){ /* ignore */ }
    // reload matches
    await loadMatches();
  }

</script>
</body>
</html>
