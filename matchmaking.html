<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc, query } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { firebaseConfig } from "./firebase.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const resultDiv = document.getElementById("matchResults");

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      try {
        // Load saved preferences
        const prefSnap = await getDoc(doc(db, "preferences", user.uid));
        if (!prefSnap.exists()) {
          resultDiv.innerHTML = "<p>You havenâ€™t set preferences yet. Go back and fill them in.</p>";
          return;
        }
        const prefs = prefSnap.data();

        // Parse age range
        const [minAge, maxAge] = prefs.ageRange.split("-").map(num => parseInt(num.trim()));

        // Fetch all profiles
        const q = query(collection(db, "profiles"));
        const querySnapshot = await getDocs(q);

        let results = [];
        querySnapshot.forEach((doc) => {
          const profile = doc.data();
          const age = parseInt(profile.age);

          if (
            profile.matchType === prefs.matchType &&
            profile.campus.toLowerCase().includes(prefs.campus.toLowerCase()) &&
            age >= minAge && age <= maxAge
          ) {
            results.push(profile);
          }
        });

        resultDiv.innerHTML = "";
        if (results.length === 0) {
          resultDiv.innerHTML = "<p>No matches found based on your preferences.</p>";
          return;
        }

        results.forEach(user => {
          resultDiv.innerHTML += `
            <div class="match-card">
              <h3>${user.name}</h3>
              <p><strong>Age:</strong> ${user.age}</p>
              <p><strong>Campus:</strong> ${user.campus}</p>
              <p><strong>Interests:</strong> ${user.interests}</p>
              <p><strong>Bio:</strong> ${user.bio}</p>
            </div>
          `;
        });

      } catch (err) {
        console.error("Error loading matches:", err);
        resultDiv.innerHTML = "<p>Something went wrong while loading matches.</p>";
      }
    } else {
      resultDiv.innerHTML = "<p>Please log in first.</p>";
      window.location.href = "login.html";
    }
  });
</script>
