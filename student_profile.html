<script type="module">
  import { auth, db } from './firebase.js';
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
  import { doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  const profilePicEl = document.getElementById('profilePic');
  const avatarPreview = document.getElementById('avatarPreview');

  const nameEl = document.getElementById('name');
  const nickEl = document.getElementById('nickname');
  const countyEl = document.getElementById('county');
  const ageEl = document.getElementById('age');
  const uniEl = document.getElementById('university');
  const yearEl = document.getElementById('year');
  const courseEl = document.getElementById('course');

  const chips = document.querySelectorAll('.chip');
  const interestedEl = document.getElementById('interestedIn');
  const prefCountyEl = document.getElementById('prefCounty');
  const prefUniEl = document.getElementById('prefUniversity');
  const prefYearEl = document.getElementById('prefYear');
  const prefAgeEl = document.getElementById('prefAgeRange');

  const errorEl = document.getElementById('error');
  const saveBtn = document.getElementById('saveBtn');
  const savingEl = document.getElementById('saving');

  // chip selection
  const selectedLooking = new Set();
  chips.forEach(chip => {
    chip.addEventListener('click', () => {
      const v = chip.dataset.value;
      if (selectedLooking.has(v)) {
        selectedLooking.delete(v);
        chip.classList.remove('active');
      } else {
        selectedLooking.add(v);
        chip.classList.add('active');
      }
    });
  });

  // preview image
  profilePicEl.addEventListener('change', e => {
    const f = e.target.files[0];
    if (!f) return;
    if (f.size > 2 * 1024 * 1024) {
      alert("Image must be under 2MB.");
      profilePicEl.value = "";
      return;
    }
    avatarPreview.src = URL.createObjectURL(f);
  });

  // ensure login
  let currentUser = null;
  onAuthStateChanged(auth, user => {
    if (!user) {
      window.location.href = 'login.html';
      return;
    }
    currentUser = user;
  });

  function validate() {
    if (!nameEl.value.trim()) return "Enter your full name";
    if (!nickEl.value.trim()) return "Enter nickname";
    if (!countyEl.value.trim()) return "Enter county";
    if (!ageEl.value || Number(ageEl.value) < 18) return "Age must be 18+";
    if (!uniEl.value.trim()) return "Enter university";
    if (!yearEl.value) return "Select year";
    if (!courseEl.value.trim()) return "Enter course";
    if (selectedLooking.size === 0) return "Choose what you are looking for";
    if (!interestedEl.value) return "Select who you're interested in";
    if (!prefCountyEl.value.trim()) return "Enter preferred county";
    if (!prefAgeEl.value.trim()) return "Enter preferred age range";
    if (interestedEl.value !== "Outsider") {
      if (!prefUniEl.value.trim()) return "Enter preferred university";
      if (!prefYearEl.value.trim()) return "Enter preferred year";
    }
    if (!profilePicEl.files[0]) return "Upload a profile photo";
    return null;
  }

  // CLOUDINARY UPLOAD FUNCTION
  async function uploadToCloudinary(file) {
    const url = `https://api.cloudinary.com/v1_1/dhtmhaucz/image/upload`;

    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", "campusConnect");  // YOU MUST CREATE THIS IN CLOUDINARY SETTINGS

    const res = await fetch(url, { method: "POST", body: formData });
    const data = await res.json();

    if (!data.secure_url) throw new Error("Cloudinary upload failed");
    return data.secure_url;
  }

  // SAVE PROFILE
  saveBtn.addEventListener("click", async () => {
    const v = validate();
    if (v) {
      errorEl.textContent = v;
      errorEl.style.display = "block";
      return;
    }

    errorEl.style.display = "none";
    savingEl.style.display = "block";
    saveBtn.disabled = true;

    try {
      const file = profilePicEl.files[0];

      // UPLOAD TO CLOUDINARY
      const imageURL = await uploadToCloudinary(file);

      // BUILD DATA
      const data = {
        uid: currentUser.uid,
        email: currentUser.email,
        name: nameEl.value.trim(),
        nickname: nickEl.value.trim(),
        county: countyEl.value.trim(),
        age: Number(ageEl.value),
        university: uniEl.value.trim(),
        year: yearEl.value,
        course: courseEl.value.trim(),
        lookingFor: Array.from(selectedLooking),
        interestedIn: interestedEl.value,
        matchPreferences: {
          county: prefCountyEl.value.trim(),
          university: prefUniEl.value.trim(),
          year: prefYearEl.value.trim(),
          ageRange: prefAgeEl.value.trim()
        },
        profilePic: imageURL,
        userType: "student",
        createdAt: serverTimestamp()
      };

      // SAVE IN FIRESTORE
      await setDoc(doc(db, "students", currentUser.uid), data);

      savingEl.textContent = "Profile saved! Redirecting...";
      setTimeout(() => {
        window.location.href = "home.html";
      }, 800);

    } catch (err) {
      console.error(err);
      errorEl.textContent = err.message || "Save failed";
      errorEl.style.display = "block";
    }

    saveBtn.disabled = false;
    savingEl.style.display = "none";
  });
</script>
