<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Messages ‚Äî CampusConnect</title>
<style>
  :root{ --bg1:#120013; --pink1:#ff7ab6; --pink2:#ff3b88 }
  body{margin:0;font-family:Inter, Poppins, system-ui;background:linear-gradient(180deg,#120013,#2a0620);color:#fff;min-height:100vh}
  .wrap{display:flex;max-width:1100px;margin:20px auto;gap:18px;padding:12px}
  .col-left{width:300px;background:rgba(255,255,255,0.03);border-radius:12px;padding:12px}
  .col-right{flex:1;background:rgba(255,255,255,0.03);border-radius:12px;padding:12px;display:flex;flex-direction:column}
  .match-item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;cursor:pointer}
  .match-item img{width:52px;height:52px;border-radius:50%;object-fit:cover}
  .match-item .meta{flex:1}
  .chat-area{flex:1; overflow:auto;padding:12px;border-radius:8px;background:rgba(0,0,0,0.04)}
  .bubble{display:inline-block;padding:10px 12px;border-radius:12px;margin:8px 0;max-width:70%}
  .from-me{background:linear-gradient(90deg,var(--pink1),var(--pink2));color:#fff;align-self:flex-end}
  .from-them{background:rgba(255,255,255,0.08);color:#fff;align-self:flex-start}
  .composer{display:flex;gap:8px;padding-top:8px;align-items:center}
  input[type="text"]{flex:1;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.04);color:#fff}
  .send-btn{padding:10px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--pink1),var(--pink2));cursor:pointer}
  .file-input{display:none}
  img.msg-image{max-width:220px;border-radius:10px;display:block;margin-top:6px}
  .empty{padding:24px;text-align:center;color:#ffd6ea}
</style>
</head>
<body>
  <div class="wrap">
    <div class="col-left">
      <h3 style="margin-top:0">Your Matches</h3>
      <div id="matchesList">Loading matches...</div>
    </div>

    <div class="col-right">
      <div id="chatHeader" style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)"></div>
      <div id="chatArea" class="chat-area"></div>

      <div class="composer">
        <input id="messageInput" type="text" placeholder="Write a message..." />
        <label class="send-btn" title="Send image">
          üì∑
          <input id="imageInput" class="file-input" type="file" accept="image/*">
        </label>
        <button id="sendBtn" class="send-btn">Send</button>
      </div>
    </div>
  </div>

<script type="module">
  import { auth, db, storage } from './firebase.js';
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
  import { collection, getDocs, doc, getDoc, query, where, setDoc, addDoc, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
  import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

  const matchesList = document.getElementById('matchesList');
  const chatArea = document.getElementById('chatArea');
  const chatHeader = document.getElementById('chatHeader');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const imageInput = document.getElementById('imageInput');

  let currentUser = null;
  let matches = []; // {id, otherUid, otherProfile}
  let activeChatId = null;
  let activeOther = null;
  let unsubMessages = null;

  onAuthStateChanged(auth, async user => {
    if(!user) { window.location.href = 'login.html'; return; }
    currentUser = user;
    await loadMatchesList();
  });

  async function loadMatchesList(){
    matchesList.innerHTML = '';
    // load matches where current user is part of the match
    const matchesSnap = await getDocs(collection(db,'matches'));
    const myMatches = matchesSnap.docs.map(d=> ({id:d.id, ...d.data()}))
                      .filter(m => Array.isArray(m.users) && m.users.includes(currentUser.uid));

    if(myMatches.length === 0){
      matchesList.innerHTML = '<div class="empty">No matches yet. Like someone to match and start chatting ‚ù§Ô∏è</div>';
      return;
    }

    // build small items
    for(const m of myMatches){
      const otherUid = m.users.find(u => u !== currentUser.uid);
      // fetch profile from students or outsiders
      let prof = null;
      const sDoc = await getDoc(doc(db,'students',otherUid));
      if(sDoc.exists()) prof = sDoc.data();
      else {
        const oDoc = await getDoc(doc(db,'outsiders',otherUid));
        if(oDoc.exists()) prof = oDoc.data();
      }
      const item = document.createElement('div');
      item.className = 'match-item';
      item.innerHTML = `<img src="${(prof && prof.profilePic) || 'https://via.placeholder.com/120x120.png?text=No+Photo'}">
                        <div class="meta"><div style="font-weight:700">${(prof && prof.nickname) || (prof && prof.name) || 'User'}</div>
                        <div class="small" style="font-size:13px">${prof?.age ? prof.age + ' yrs' : ''} ${prof?.county ? '‚Ä¢ '+prof.county : ''}</div></div>`;
      item.addEventListener('click', ()=> openChat(m.id, otherUid, prof));
      matchesList.appendChild(item);
    }
  }

  // open chat with matchId
  async function openChat(matchId, otherUid, otherProfile){
    activeChatId = matchId;
    activeOther = {uid: otherUid, profile: otherProfile};
    chatHeader.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><img src="${otherProfile?.profilePic || 'https://via.placeholder.com/120'}" style="width:48px;height:48px;border-radius:50%;object-fit:cover"><div><div style="font-weight:800">${otherProfile?.nickname || otherProfile?.name}</div><div style="font-size:12px;color:#ffd6ea">${otherProfile?.county || ''}</div></div></div>`;
    // detach previous subscribe
    if(unsubMessages) unsubMessages();
    chatArea.innerHTML = '';
    // subscribe to messages in this chat
    const msgsRef = collection(db, 'chats', matchId, 'messages');
    const q = query(msgsRef, orderBy('createdAt', 'asc'));
    unsubMessages = onSnapshot(q, snapshot => {
      chatArea.innerHTML = '';
      snapshot.docs.forEach(d=>{
        const m = d.data();
        const bubble = document.createElement('div');
        bubble.className = 'bubble ' + (m.from === currentUser.uid ? 'from-me' : 'from-them');
        if(m.type === 'text') bubble.textContent = m.text;
        else if(m.type === 'image'){
          const img = document.createElement('img'); img.className='msg-image'; img.src = m.imageUrl;
          bubble.appendChild(img);
          if(m.text) bubble.appendChild(document.createElement('div')).innerText = m.text;
        }
        chatArea.appendChild(bubble);
      });
      chatArea.scrollTop = chatArea.scrollHeight;
    });
  }

  // send text or image
  sendBtn.addEventListener('click', async ()=>{
    if(!activeChatId) return alert('Select a match to chat with');
    const text = messageInput.value.trim();
    const file = imageInput.files[0];
    if(!text && !file) return;
    try{
      const messagesRef = collection(db, 'chats', activeChatId, 'messages');
      const msg = { from: currentUser.uid, createdAt: new Date() };
      if(file){
        if(file.size > 3*1024*1024){ alert('Image too big (max 3MB)'); return; }
        const storageRef = ref(storage, `chats/${activeChatId}/${Date.now()}_${file.name}`);
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        msg.type = 'image'; msg.imageUrl = url; msg.text = text || '';
      } else {
        msg.type = 'text'; msg.text = text;
      }
      // add message
      await addDoc(collection(db, 'chats', activeChatId, 'messages'), msg);
      messageInput.value = ''; imageInput.value = '';
    } catch(err){ console.error(err); alert('Failed to send: '+ err.message); }
  });

</script>
</body>
</html>
